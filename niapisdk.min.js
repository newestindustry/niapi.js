/*global ActiveXObject: false */window.NI=function(){var e={api_url:"https://api.newestindustry.nl",auth_url:"/oauth/auth/",client_id:!1,redirect_uri:!1,scope:"default",oauth_token:!1,refresh_token:!1,error:!1,me:!1,root:document.getElementById("ni-root"),sidebar_no_margin:!1,init:function(t){if(typeof t!="undefined"){e.api_url=typeof t.api_url!="undefined"?t.api_url:e.api_url;e.client_id=typeof t.client_id!="undefined"?t.client_id:!1;e.redirect_uri=typeof t.redirect_uri!="undefined"?t.redirect_uri:!1;e.sidebar_no_margin=typeof t.sidebar_no_margin!="undefined"?!0:!1}e.parseToken()},emptyCallback:function(){},parseToken:function(){var t={},n=location.hash.substring(1),r=/([^&=]+)=([^&]*)/g,i=r.exec(n);i&&(t[decodeURIComponent(i[1])]=decodeURIComponent(i[2]));if(t.token){e.oauth_token=t.token;localStorage.oauth_token=e.oauth_token}else localStorage.oauth_token&&(e.oauth_token=localStorage.oauth_token);t.error&&(e.error=t.error)},setToken:function(t){e.oauth_token=t;localStorage.oauth_token=e.oauth_token},Me:function(t){e.Get("/me",t)},Login:function(){e.oauth_token||(location.href=e.api_url+e.auth_url+"?response_type=token&client_id="+e.client_id+"&redirect_uri="+e.redirect_uri+"&scope="+e.scope)},Logout:function(){e.oauth_token&&e.Delete("/oauth/token",e.emptyCallback);e.oauth_token=!1;localStorage.removeItem("oauth_token")},Get:function(t,n){e.call(t,n,"GET")},Post:function(t,n,r){typeof r=="object"&&(r=e.toQueryString(r));e.call(t,n,"POST",r)},Put:function(t,n,r){typeof r=="object"&&(r=e.toQueryString(r));e.call(t,n,"PUT",r)},Delete:function(t,n){e.call(t,n,"DELETE")},toQueryString:function(e){var t="",n="";for(var r in e){t+=n;t+=encodeURIComponent(r)+"="+encodeURIComponent(e[r]);n="&"}return t},loadSidebar:function(){e.Get("/frontend/menu/left/_format/html",function(t,n){document.getElementById("ni-root").innerHTML=n;e.sidebar_no_margin===!1&&(document.body.style.marginLeft="230px");e.call("/mail/messages/thread/false/read/false/_limit/1",function(e,t){document.getElementById("ni-totalUnreadMessages").innerHTML=t.total})})},getMessages:function(){e.Get("/mail/messages/thread/false/_limit/5/_sort/created/_direction/desc/_format/html",function(e,t){document.getElementById("ni-messagesPreviewList").innerHTML=t;document.getElementById("ni-messagesPreview").style.display==="none"?document.getElementById("ni-messagesPreview").style.display="block":document.getElementById("ni-messagesPreview").style.display="none"})},getComments:function(t,n){if(typeof t!="undefined"){t.url=typeof t.url!="undefined"?t.url:window.location.href;t.id=typeof t.id!="undefined"?t.id:!1}typeof n=="undefined"&&(n=e.emptyCallback);console.log(encodeURIComponent(t.url));e.Get("/comments/_format/html/url/"+encodeURIComponent(t.url),function(r,i){document.getElementById(t.id).innerHTML=i;document.getElementById("niCreateCommentFormUrl").value=t.url;e.commentFixSubmit(t,n)})},commentFixSubmit:function(t,n){document.getElementById("niCreateComment").onsubmit=function(){var r=serialize(document.getElementById("niCreateComment"));e.Post("/comments",function(r){r||e.getComments(t,n)},r);return!1}},call:function(t,n,r,i){var s,o,u,a;t=e.api_url+t;try{o=new XMLHttpRequest}catch(f){try{o=new ActiveXObject("Msxml2.XMLHTTP")}finally{typeof console!="undefined"&&console.log("NIApi: Not supported");return null}}s=setTimeout(function(){o.abort();n(new Error("NIApi: Timeout Reached"),"",o)},1e4);o.onreadystatechange=function(){if(o.readyState!==4)return;clearTimeout(s);if(o.status===200||o.status===201||o.status===204)a=!1;else if(o.status===401){e.Logout();a=new Error("NIApi: Access denied")}else a=new Error("NIApi: Response status: "+o.status);var t;o.getResponseHeader("content-type").indexOf("application/json")!==-1?t=JSON.parse(o.responseText):t=o.responseText;n(a,t,o)};r?u=r.toUpperCase():u="GET";o.open(u,t+"/_ts/"+Date.now(),!0);e.oauth_token&&o.setRequestHeader("Authorization","oauth_token "+e.oauth_token);if(!i)o.send();else{o.setRequestHeader("Content-type","application/x-www-form-urlencoded");o.send(i)}return!1}};return e}();